<html>
<head>
  <link rel="stylesheet" href="styles.css">
</head>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<body onload="init()">
<div class="main">
  <div class="sidebar">
    <div id="2007" class="imgDiv"><img class="sideImage" src="imgs/2007.png"></img><h2>2007</h2></div> 
    <div id="2008" class="imgDiv"><img class="sideImage" src="imgs/2008.png"></img><h2>2008</h2></div> 
    <div id="2009" class="imgDiv"><img class="sideImage" src="imgs/2009.png"></img><h2>2009</h2></div> 
    <div id="2010" class="imgDiv"><img class="sideImage" src="imgs/2010.png"></img><h2>2010</h2></div> 
    <div id="2011" class="imgDiv"><img class="sideImage" src="imgs/2011.png"></img><h2>2011</h2></div> 
    <div id="2012" class="imgDiv"><img class="sideImage" src="imgs/2012.png"></img><h2>2012</h2></div> 
    <div id="2014" class="imgDiv"><img class="sideImage" src="imgs/2014.png"></img><h2>2014</h2></div> 
    <div id="2015" class="imgDiv"><img class="sideImage" src="imgs/2015.png"></img><h2>2015</h2></div> 
    <div id="2016" class="imgDiv"><img class="sideImage" src="imgs/2016.png"></img><h2>2016</h2></div> 
    <div id="2017" class="imgDiv"><img class="sideImage" src="imgs/2017.png"></img><h2>2017</h2></div> 
    <div id="2018" class="imgDiv"><img class="sideImage" src="imgs/2018.png"></img><h2>2018</h2></div> 
    <div id="2019" class="imgDiv"><img class="sideImage" src="imgs/2019.png"></img><h2>2019</h2></div> 
    <div id="2021" class="imgDiv"><img class="sideImage" src="imgs/2021.png"></img><h2>2021</h2></div> 
  </div>
  <div class="centerContainer">
    <h1>Indianapolis Violent Crime</h1>
    <div class="centerDisplay">
      <div id="introBox">
        <h1 id="introYear">2007</h1>
        <h2 id="introHom"></h2>
        <h2 id="introRap"></h2>
        <h2 id="introAssault"></h2>
      </div>
      <img id="indymap" src="imgs/IndyMap.png"></img>
      <svg viewBox="0 0 700 600">
        <g fill="none" stroke="#000" stroke-linejoin="round" stroke-linecap="round">
        </g>
      </svg>
    </div>
  </div>
</div>
<script>

function calculateMapFadeIn(entry, year, timeStart, totalDuration){
  const start = new Date(year,1,1);
  const end = new Date(year,12,31);
  const day = new Date(Date.parse(entry.DATETIME));
  day.setMonth(day.getMonth() + 1);

  //use Math.abs to avoid sign
  const q = Math.abs(day-start);
  const d = Math.abs(end-start);
  
  const percent = (q/d);
  return timeStart + totalDuration*percent;
}

async function triggerAnimation(data, year, dur, animStart) {
  //Show minimap after animation completes
  let promises = [];

  // HOMICIDE
  data.filter(function(d){ return d.CATEGORY === "CRIMINAL HOMICIDE"; })
   .forEach(function(d, i){
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
        d3.select('svg')
          .append('circle')
            .attr("cx", projection([d.X_COORD, d.Y_COORD])[0])
            .attr('cy', projection([d.X_COORD, d.Y_COORD])[1])
            .attr('r', '8px' )
            .style("opacity", 1)
            .attr("fill", '#1f2124')
            .transition()
            .duration(1000)
            .style("opacity", 0.8)
            .attr('r', '5px' );
        resolve();
      }, calculateMapFadeIn(d, year, animStart, dur));
      }));
  });

  // RAPE
  data.filter(function(d){ return d.CATEGORY === "RAPE"; })
   .forEach(function(d, i){
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
          d3.select('svg')
            .append('circle')
              .attr("cx", projection([d.X_COORD, d.Y_COORD])[0])
              .attr('cy', projection([d.X_COORD, d.Y_COORD])[1])
              .attr('r', '3px' )
              .style("opacity", 1)
              .attr("fill", 'red')
              .transition()
              .duration(500)
              .style("opacity", 0.4)
              .attr('r', '2px' );
          resolve();
        }, calculateMapFadeIn(d, year, animStart, dur));
      }));
  });

  // ASSAULT
  data.filter(function(d){ return d.CATEGORY === "ASSAULT"; })
   .forEach(function(d, i){
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
          d3.select('svg')
            .append('circle')
              .attr("cx", projection([d.X_COORD, d.Y_COORD])[0])
              .attr('cy', projection([d.X_COORD, d.Y_COORD])[1])
              .attr('r', '3px' )
              .style("opacity", 1)
              .attr("fill", '#0a4a2a')
              .transition()
              .duration(200)
              .style("opacity", 0.2)
              .attr('r', '2px' );
          resolve();
        }, calculateMapFadeIn(d, year, animStart, dur));
      }));
  });

  console.log("Awaiting animation completion");
  await Promise.allSettled(promises);
  console.log("Completed animation");
}

function dataStats(data) {
  let initialValue = 0;
  let sumHomicides = 0;
  let sumRapes = 0;
  let sumAssault = 0;

  sumHomicides = data.filter(function(d){ return d.CATEGORY === "CRIMINAL HOMICIDE"; }).length
  sumRapes = data.filter(function(d){ return d.CATEGORY === "RAPE"; }).length
  sumAssault = data.filter(function(d){ return d.CATEGORY === "ASSAULT"; }).length

  return [sumHomicides, sumRapes, sumAssault]
}

async function init() {
  //https://www.coursera.org/learn/cs-416-dv/assignment-submission/Y5Kdl/create-a-narrative-visualization/attempt
  //https://observablehq.com/@d3/u-s-map
  //open /Applications/Google\ Chrome.app --args --user-data-dir="/var/tmp/chrome-dev-disabled-security" --disable-web-security --disable-site-isolation-trials
  //file:///Users/rmmays/Documents/MitchCode/D3_Project/mitchell-mays.github.io/index.html

  // ================================================
  // ================================================
  // Step 1: Load the streets and visualize the city
  // ================================================
  // ================================================

  
  indianaRoads = await d3.json("./Road_Centerlines_of_Indiana_2021.json");
  width = 700;
  height = 600;
  projection = d3.geoAlbers().rotate([85]);
  projection.fitSize([width,height],indianaRoads);

  /*
  path = d3.geoPath().projection(projection);

  geojson_base = {
    "type": "FeatureCollection",
    "features": []
  };

  // Deep copy base
  geojson_highways = JSON.parse(JSON.stringify(geojson_base));
  indianaRoadsHighways = indianaRoads.features.filter(function(d){ return (d.properties.speedlimit >= 50); })
  geojson_highways.features = indianaRoadsHighways
  console.log(indianaRoadsHighways.length)

  d3.select('g')
    .append('path')
      .attr('stroke', '#000')
      .attr('stroke-width', '2')
      .attr('d', path(geojson_highways))
      .attr("fill", "none");


  // Deep copy base
  geojson_roads1 = JSON.parse(JSON.stringify(geojson_base));
  indianaRoads1 = indianaRoads.features.filter(function(d){ return (d.properties.speedlimit >= 35); })
  geojson_roads1.features = indianaRoads1
  console.log(indianaRoads1.length)

  d3.select('g')
    .append('path')
      .attr('stroke', '#aaa')
      .attr('stroke-width', '1')
      .attr('d', path(geojson_roads1))
      .attr("fill", "none");

  // Deep copy base
  geojson_roads2 = JSON.parse(JSON.stringify(geojson_base));
  indianaRoads2 = indianaRoads.features.filter(function(d){ return (d.properties.speedlimit < 35); })
  geojson_roads2.features = indianaRoads2
  console.log(indianaRoads2.length)

  d3.select('g')
    .append('path')
      .attr('stroke', '#aaa')
      .attr('stroke-width', '0.5')
      .attr('d', path(geojson_roads2))
      .attr("fill", "none");
  */
  
  // ================================================
  // ================================================
  // Step 2: Trigger Animation for All Years
  // ================================================
  // ================================================

  let years  = [2007, 2008, 2009, 2010, 2011, 2012, 2014, 2015, 2016, 2017, 2018, 2019, 2021];
  let introDelay = 3000;
  let dur = 5000;
  let animStart = 1000;
  let delay = 500;
  let stats = [];
  

  for (let i = 0; i < years.length; i++) {
    data = await d3.csv("./data/IMPD_UCR_" +  years[i] + "_Data.csv");
    data = await data.filter(function(d){ return ((d.X_COORD !== "0.0") && (d.Y_COORD !== "0.0")); });

    // Display Stats
    stats = dataStats(data);
    d3.select("#introYear").html(years[i]);
    d3.select("#introHom").html("Homicide: " + stats[0]);
    d3.select("#introRap").html("Rape: " + stats[1]);
    d3.select("#introAssault").html("Assault: " + stats[2]);
    
    d3.select("#introBox").style("display","flex")

    // Delay - then remove stats display
    await new Promise((resolve, reject) => {setTimeout(resolve, introDelay)});
    d3.select("#introBox").style("display","none")

    await triggerAnimation(data, years[i], dur, animStart);

    let promises = [];

    promises.push(new Promise((resolve, reject) => {
      setTimeout(function(){
        document.getElementById(years[i]).style.display = "flex";
        resolve();
      }, 500);
    }));

    if (i !== (years.length-1)) {
      // Clear main map after animation
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
          d3.selectAll("circle").remove();
          resolve();
        }, 500);
      }));
    }
    
    console.log("Awaiting clearing steps");
    await Promise.allSettled(promises);
    console.log("Awaiting cleared");
  }

  /*
  xdomain = [2008, 2023];
  xrange = [0,1];
  ydomain = [0,337];
  yrange = [0,1];

  xs = d3.scaleLinear().domain(xdomain).range(xrange);
  ys = d3.scaleLinear().domain(ydomain).range(yrange);
  */
}

</script>
</body>
</html>