<html>
<head>
  <link rel="stylesheet" href="styles.css">
</head>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<body onload="init()">
<div class="main">
  <div class="sidebar">
    <div id="2007" class="imgDiv"><img class="sideImage" src="imgs/2007.png"></img><h2>2007</h2></div> 
    <div id="2008" class="imgDiv"><img class="sideImage" src="imgs/2008.png"></img><h2>2008</h2></div> 
    <div id="2009" class="imgDiv"><img class="sideImage" src="imgs/2009.png"></img><h2>2009</h2></div> 
    <div id="2010" class="imgDiv"><img class="sideImage" src="imgs/2010.png"></img><h2>2010</h2></div> 
    <div id="2011" class="imgDiv"><img class="sideImage" src="imgs/2011.png"></img><h2>2011</h2></div> 
    <div id="2012" class="imgDiv"><img class="sideImage" src="imgs/2012.png"></img><h2>2012</h2></div> 
    <div id="2014" class="imgDiv"><img class="sideImage" src="imgs/2014.png"></img><h2>2014</h2></div> 
    <div id="2015" class="imgDiv"><img class="sideImage" src="imgs/2015.png"></img><h2>2015</h2></div> 
    <div id="2016" class="imgDiv"><img class="sideImage" src="imgs/2016.png"></img><h2>2016</h2></div> 
    <div id="2017" class="imgDiv"><img class="sideImage" src="imgs/2017.png"></img><h2>2017</h2></div> 
    <div id="2018" class="imgDiv"><img class="sideImage" src="imgs/2018.png"></img><h2>2018</h2></div> 
    <div id="2019" class="imgDiv"><img class="sideImage" src="imgs/2019.png"></img><h2>2019</h2></div> 
    <div id="2021" class="imgDiv"><img class="sideImage" src="imgs/2021.png"></img><h2>2021</h2></div> 
  </div>
  <div class="centerContainer">
    <h1>Indianapolis Violent Crime</h1>
    <div class="centerDisplay">
      <div id="introBox">
        <h1 id="introYear">2007</h1>
        <h2 id="introHom"></h2>
        <h2 id="introRap"></h2>
        <h2 id="introAssault"></h2>
      </div>
      <img id="indymap" src="imgs/IndyMap.png"></img>
      <svg id="mainSVG" viewBox="0 0 700 600">
        <g fill="none" stroke="#000" stroke-linejoin="round" stroke-linecap="round">
        </g>
      </svg>
    </div>
    <div class="slider">
      <h2>2007</h2>
    </div>
  </div>
  <div class="rightPane"> 
    <div class="graph">
      <h2 id="graphTitle">Crime Counts over Time</h2>
      <svg id="rightSVG" viewBox="0 0 500 400">
      </svg>
      <svg id="legend">
      </svg>
    </div>
  </div>
</div>
<script>

function calculateMapFadeIn(entry, year, timeStart, totalDuration){
  const start = new Date(year,1,1);
  const end = new Date(year,12,31);
  const day = new Date(Date.parse(entry.DATETIME));
  day.setMonth(day.getMonth() + 1);

  //use Math.abs to avoid sign
  const q = Math.abs(day-start);
  const d = Math.abs(end-start);
  
  const percent = (q/d);
  return timeStart + totalDuration*percent;
}

function graphSetup(width, height){
  var x = d3.scaleTime()
    .domain([new Date(2007,1,1), new Date(2021,1,1)]).range([ 0, width ]).nice();
  d3.select("#rightSVG")
    .append("g")
    .attr("transform", "translate(" + margin + "," + height + ")")
    .call(d3.axisBottom(x));

  // Add Y axis
  var y = d3.scaleLinear()
    .domain([0, 1500])
    .range([ height, 5 ]);
  d3.select("#rightSVG")
    .append("g")
    .attr("transform", "translate(" + margin + ",0)")
    .call(d3.axisLeft(y));


  // Add Legend
  svg = d3.select("#legend");
  svg.append("circle").attr("cx",20).attr("cy",30).attr("r", 6).style("fill", "#1f2124")
  svg.append("circle").attr("cx",20).attr("cy",60).attr("r", 6).style("fill", "red")
  svg.append("circle").attr("cx",20).attr("cy",90).attr("r", 6).style("fill", "#0a4a2a")
  svg.append("text").attr("x", 40).attr("y", 30).text("Homicide").style("font-size", "15px").attr("alignment-baseline","middle")
  svg.append("text").attr("x", 40).attr("y", 60).text("Rape (incl. attempted)").style("font-size", "15px").attr("alignment-baseline","middle")
  svg.append("text").attr("x", 40).attr("y", 90).text("Assault / 5").style("font-size", "15px").attr("alignment-baseline","middle")
}

function graphBuild(year, stats, graphData){
  d3.select("#rightSVG").selectAll(".line").remove();
  
  // Homicide
    d3.select("#rightSVG")
      .append("circle")
      .attr("cx", xs(year) )
      .attr("cy", ys(stats[0]))
      .attr("r", 3)
      .attr("transform", "translate(" + margin + "," + 0 + ")")
      .style("fill", "#1f2124");
    
    d3.select("#rightSVG")
      .append("path")
      .datum(graphData) 
      .attr("class", "line") 
      .attr("transform", "translate(" + margin + "," + 0 + ")")
      .style("fill", "none")
      .style("stroke", "#1f2124")
      .style("stroke-width", "2")
      .attr("d", d3.line()
        .x(function(d) { return xs(d.YEAR) })
        .y(function(d) { return ys(d.HOM) })
        .curve(d3.curveMonotoneX)
        );

    // Rape
    d3.select("#rightSVG")
      .append("circle")
      .attr("cx", xs(year) )
      .attr("cy", ys(stats[1]))
      .attr("r", 3)
      .attr("transform", "translate(" + margin + "," + 0 + ")")
      .style("fill", "red");

    d3.select("#rightSVG")
      .append("path")
      .datum(graphData) 
      .attr("class", "line") 
      .attr("transform", "translate(" + margin + "," + 0 + ")")
      .style("fill", "none")
      .style("stroke", "red")
      .style("stroke-width", "2")
      .attr("d", d3.line()
        .x(function(d) { return xs(d.YEAR) })
        .y(function(d) { return ys(d.RAPE) })
        .curve(d3.curveMonotoneX)
        );

    
    // Assault
    d3.select("#rightSVG")
      .append("circle")
      .attr("cx", xs(year) )
      .attr("cy", ys(stats[2] / 5))
      .attr("r", 3)
      .attr("transform", "translate(" + margin + "," + 0 + ")")
      .style("fill", "#0a4a2a");
    
    d3.select("#rightSVG")
      .append("path")
      .datum(graphData) 
      .attr("class", "line") 
      .attr("transform", "translate(" + margin + "," + 0 + ")")
      .style("fill", "none")
      .style("stroke", "#0a4a2a")
      .style("stroke-width", "2")
      .attr("d", d3.line()
        .x(function(d) { return xs(d.YEAR) })
        .y(function(d) { return ys(d.ASSAULT / 5) })
        .curve(d3.curveMonotoneX)
        );
    
}

function progressSliderBuild() {
  var svg = d3.select('.slider')
		.append('svg')
		.attr('height', 100)
		.attr('width', 500);

  var barWidth = 500;

	svg.append('rect')
		.attr('class', 'bg-rect')
		.attr('rx', 10)
		.attr('ry', 10)
		.attr('fill', 'gray')
		.attr('height', 15)
		.attr('width', barWidth)
		.attr('x', 0);

	var progress = svg.append('rect')
    .attr('class', 'slide-block')
    .attr('fill', '#DCDCDC')
    .attr('height', 15)
    .attr('width', 0)
    .attr('rx', 10)
    .attr('ry', 10)
    .attr('x', 0);

  svg.append("text").attr("x", 0).attr("y", 30).text("January 1st").style("font-size", "15px").attr("alignment-baseline","middle")
  svg.append("text").attr("x", 400).attr("y", 30).text("December 31st").style("font-size", "15px").attr("alignment-baseline","middle")
}

async function triggerAnimation(data, year, dur, animStart) {
  //Show minimap after animation completes
  let promises = [];

  // Setup progress indicator
  d3.select(".slide-block").attr('width', 0);

  promises.push(new Promise((resolve, reject) => { 
    setTimeout(function(){
      d3.select(".slide-block").transition()
      .ease(d3.easeLinear)
      .duration(dur)
      .attr('width', 500);
      resolve();
    }, animStart);
  }));

  // HOMICIDE
  data.filter(function(d){ return d.CATEGORY === "CRIMINAL HOMICIDE"; })
   .forEach(function(d, i){
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
        d3.select('#mainSVG')
          .append('circle')
            .attr("cx", projection([d.X_COORD, d.Y_COORD])[0])
            .attr('cy', projection([d.X_COORD, d.Y_COORD])[1])
            .attr('r', '8px' )
            .style("opacity", 1)
            .attr("fill", '#1f2124')
            .transition()
            .duration(1000)
            .style("opacity", 0.8)
            .attr('r', '5px' );
        resolve();
      }, calculateMapFadeIn(d, year, animStart, dur));
      }));
  });

  // RAPE
  data.filter(function(d){ return d.CATEGORY === "RAPE"; })
   .forEach(function(d, i){
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
          d3.select('#mainSVG')
            .append('circle')
              .attr("cx", projection([d.X_COORD, d.Y_COORD])[0])
              .attr('cy', projection([d.X_COORD, d.Y_COORD])[1])
              .attr('r', '3px' )
              .style("opacity", 1)
              .attr("fill", 'red')
              .transition()
              .duration(500)
              .style("opacity", 0.4)
              .attr('r', '2px' );
          resolve();
        }, calculateMapFadeIn(d, year, animStart, dur));
      }));
  });

  // ASSAULT
  data.filter(function(d){ return d.CATEGORY === "ASSAULT"; })
   .forEach(function(d, i){
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
          d3.select('#mainSVG')
            .append('circle')
              .attr("cx", projection([d.X_COORD, d.Y_COORD])[0])
              .attr('cy', projection([d.X_COORD, d.Y_COORD])[1])
              .attr('r', '3px' )
              .style("opacity", 1)
              .attr("fill", '#0a4a2a')
              .transition()
              .duration(200)
              .style("opacity", 0.2)
              .attr('r', '2px' );
          resolve();
        }, calculateMapFadeIn(d, year, animStart, dur));
      }));
  });

  console.log("Awaiting animation completion");
  await Promise.allSettled(promises);
  console.log("Completed animation");
}

function dataStats(data) {
  let initialValue = 0;
  let sumHomicides = 0;
  let sumRapes = 0;
  let sumAssault = 0;

  sumHomicides = data.filter(function(d){ return d.CATEGORY === "CRIMINAL HOMICIDE"; }).length
  sumRapes = data.filter(function(d){ return d.CATEGORY === "RAPE"; }).length
  sumAssault = data.filter(function(d){ return d.CATEGORY === "ASSAULT"; }).length

  return [sumHomicides, sumRapes, sumAssault]
}

async function init() {

  // ================================================
  // ================================================
  // Step 1: Load the streets and visualize the city
  // ================================================
  // ================================================

  indianaRoads = await d3.json("./Road_Centerlines_of_Indiana_2021.json");
  width = 700;
  height = 600;
  projection = d3.geoAlbers().rotate([85]);
  projection.fitSize([width,height],indianaRoads);

  /*
  See reference.js
  */
  
  // ================================================
  // ================================================
  // Step 2: Trigger Animation for All Years
  // ================================================
  // ================================================

  // Prep Animation Variables
  let years  = [2007, 2008, 2009, 2010, 2011, 2012, 2014, 2015, 2016, 2017, 2018, 2019, 2021];
  let introDelay = 3000;
  let dur = 4000;
  let animStart = 500;
  let delay = 500;
  let stats = [];
  
  // Prep Right Pane
  margin = 50;
  width = 500 - (1*margin);
  height = 400 - margin;

  xdomain = [2007, 2021];
  xrange = [0,420];
  ydomain = [1500,0];
  yrange = [0,height];

  xs = d3.scaleLinear().domain(xdomain).range(xrange);
  ys = d3.scaleLinear().domain(ydomain).range(yrange);

  graphSetup(width, height);
  progressSliderBuild();

  graphData = [];

  // Animation Loop
  for (let i = 0; i < years.length; i++) {
    data = await d3.csv("./data/IMPD_UCR_" +  years[i] + "_Data.csv");
    data = await data.filter(function(d){ return ((d.X_COORD !== "0.0") && (d.Y_COORD !== "0.0")); });

    // Display Stats
    stats = dataStats(data);
    d3.select("#introYear").html(years[i]);
    d3.select("#introHom").html("Homicide: " + stats[0]);
    d3.select("#introRap").html("Rape: " + stats[1]);
    d3.select("#introAssault").html("Assault: " + stats[2]);
    
    d3.select("#introBox").style("display","flex")
    d3.select(".slider").select("h2").html(years[i])

    // Update Right Pane
    graphData.push({ "YEAR": years[i], "HOM": stats[0], "RAPE": stats[1], "ASSAULT": stats[2] });
    graphBuild(years[i], stats, graphData);

    // Delay - then remove stats display
    await new Promise((resolve, reject) => {setTimeout(resolve, introDelay)});
    d3.select("#introBox").style("display","none")

    await triggerAnimation(data, years[i], dur, animStart);

    let promises = [];

    promises.push(new Promise((resolve, reject) => {
      setTimeout(function(){
        document.getElementById(years[i]).style.display = "flex";
        resolve();
      }, 500);
    }));

    if (i !== (years.length-1)) {
      // Clear main map after animation
      promises.push(new Promise((resolve, reject) => {
        setTimeout(function(){
          d3.select("#mainSVG").selectAll("circle").remove();
          resolve();
        }, 500);
      }));
    }
    
    console.log("Awaiting clearing steps");
    await Promise.allSettled(promises);
    console.log("Awaiting cleared");
  }
}

</script>
</body>
</html>